---
title: "data_tidy"
author: "Liu Chi Yun"
date: "4/25/2021"
output: pdf_document
---

```{r message=FALSE}
library(tidyverse)
library(lubridate)
```


```{r}
# read rds 
readr::read_rds("../data/covid19_data.rds") -> 
  covid19_data
# clean data
covid19_data %>% 
  na_if("Missing") %>% 
  na_if("Unknown") %>% 
  mutate(case_month = ym(case_month)) %>% 
  mutate(age_group = str_replace(age_group, "to", "-"),
         age_group = str_replace(age_group, "years", "")) %>% 
  mutate(age_group = as.factor(age_group),
         sex = as.factor(sex),
         hosp_yn = as.factor(hosp_yn),
         icu_yn = as.factor(icu_yn),
         death_yn = as.factor(death_yn),
         underlying_conditions_yn = as.factor(underlying_conditions_yn))  ->
  covid19_tidy
```


```{r}
# tidy data
# merge long/lat for shiny map
# only focus on the US 51 states
# long/ lat data from [link]:
# https://www.kaggle.com/washimahmed/usa-latlong-for-state-abbreviations
long_lat <- read_csv("../data/statelatlong.csv") 
  
long_lat %>% 
  rename(state = City, abbr_state = State)-> long_lat

covid19_tidy %>% 
  left_join(long_lat, by = c("res_state" = "abbr_state")) %>% 
  filter(res_state != "GU", res_state !=  "VI", res_state != "PR") -> covid19_tidy

# covid19_tidy %>% 
#   group_by(res_state)
# 
# covid19_data %>% 
#   filter(res_state == "DE")

# check if we already removed GU, VI, PR, which are outside the US territories
#setdiff(unique(covid19_tidy$res_state), unique(long_lat$abbr_state))

#setdiff(unique(long_lat$abbr_state), unique(covid19_tidy$res_state))

# only keep 2020 data
covid19_tidy %>% 
  select(-res_county) %>% 
  filter(case_month != "2021-01-01") %>% 
  filter(case_month != "2021-02-01") %>% 
  filter(case_month != "2021-03-01") ->
  covid19_tidy

covid19_tidy %>% 
  saveRDS("../data/covid19_tidy.rds")
```

```{r}
# for data analysis, lm and plot
# 51 States Total Case
covid19_tidy %>%
  group_by(res_state) %>% 
  count() %>% 
  rename("state_total_case" = "n") ->
  covid19_bystate

# new data
covid19_tidy %>% 
  group_by(res_state, symptom_status, sex, race, ethnicity, age_group, death_yn) %>% 
  count() %>% 
  pivot_wider(names_from = death_yn, values_from = n) %>% 
  rename("death" = "Yes",
         "recovery" = "No") %>% 
  left_join(covid19_bystate) %>% 
  select(-'NA') ->
  covid19_lmdf

covid19_lmdf %>% 
  saveRDS("../data/covid19_lmdf.rds")
```






